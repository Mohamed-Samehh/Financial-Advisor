<div class="container mt-5">
  <!-- Page Heading -->
  <div class="text-center mb-3">
    <h2 class="display-4 fw-normal text-primary">Track Your Expenses</h2>
    <p class="text-muted mx-auto" style="max-width: 600px;">Manage and monitor your financial activities</p>
  </div>

  <!-- Success/Error Message -->
  <div *ngIf="message" class="alert fade show mb-4 d-flex justify-content-between align-items-center"
    [ngClass]="{
      'alert-success': message.type === 'success',
      'alert-danger': message.type === 'error'
    }" role="alert">
    <div>
      <strong>{{ message.type === 'success' ? 'Success!' : 'Error!' }}</strong> {{ message.text }}
    </div>
    <button type="button" class="btn-close" (click)="message = null" aria-label="Close"></button>
  </div>

  <!-- Loader while fetching expenses -->
  <div *ngIf="isLoading" class="text-center my-5">
    <div class="spinner-border text-primary spinner-size" role="status"></div>
    <p class="fw-bold mt-3">Loading your financial data...</p>
  </div>

  <!-- Budget Card -->
  <div class="card shadow mb-4" *ngIf="!isLoading">
    <div class="card-body p-4">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="text-primary mb-0">
          <i class="fas fa-wallet me-2"></i> Monthly Budget
        </h4>
        <div>
          <button class="btn btn-sm btn-outline-primary me-2" (click)="toggleBudgetForm()">
            <i class="fas fa-{{ showBudgetForm ? 'times' : 'edit' }} me-1"></i> {{ showBudgetForm ? 'Cancel' : (budget.id ? 'Edit' : 'Set') }}
          </button>
          <button *ngIf="budget.id" class="btn btn-sm btn-outline-danger" (click)="deleteBudget(budget.id)">
            <i class="fas fa-trash-alt me-1"></i> Remove
          </button>
        </div>
      </div>
      
      <!-- Budget Form -->
      <div *ngIf="showBudgetForm" class="mb-3 p-3 bg-light rounded">
        <form (ngSubmit)="onSubmitBudget(budgetForm)" #budgetForm="ngForm">
          <div class="mb-3">
            <label for="monthlyBudget" class="form-label fw-bold">Monthly Budget:</label>
            <input
              type="number"
              id="monthlyBudget"
              [(ngModel)]="budget.monthly_budget"
              name="monthlyBudget"
              class="form-control form-control-lg"
              placeholder="Enter your budget for the month"
              required
              min="1"
              #monthlyBudget="ngModel"
              [ngClass]="{
                'is-invalid': monthlyBudget.invalid && (monthlyBudget.dirty || monthlyBudget.touched || budgetSubmitted)
              }"
            />
            <div *ngIf="monthlyBudget.invalid && (monthlyBudget.dirty || monthlyBudget.touched || budgetSubmitted)" class="text-danger">
              <div *ngIf="monthlyBudget.errors?.['required']"><i class="fas fa-exclamation-circle me-1"></i> Monthly Budget is required.</div>
              <div *ngIf="monthlyBudget.errors?.['min']"><i class="fas fa-exclamation-circle me-1"></i> Monthly Budget must be greater than 0.</div>
            </div>
          </div>
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-save me-1"></i> {{ budget.id ? 'Update Budget' : 'Set Budget' }}
          </button>
        </form>
      </div>
      
      <!-- Budget Display -->
      <div *ngIf="!showBudgetForm">
        <div class="d-flex align-items-center">
          <div class="fs-2 fw-bold me-2">E£{{ formatNumber(monthlyBudget) }}</div>
          <span class="badge bg-secondary" *ngIf="!budget.id">Not Set</span>
        </div>
        
        <!-- Budget Status -->
        <div *ngIf="budget.id" class="mt-4">
          <h5 class="text-primary mb-3">
            <i class="fas fa-chart-pie me-2"></i> Budget Status
          </h5>
          <div class="progress mb-3" style="height: 20px;">
            <div class="progress-bar fw-semibold" role="progressbar" [style.width.%]="budgetPercentUsed" 
                [ngClass]="{
                  'bg-success': budgetPercentUsed < 75,
                  'bg-warning': budgetPercentUsed >= 75 && budgetPercentUsed < 100,
                  'bg-danger': budgetPercentUsed >= 100
                }"
                [attr.aria-valuenow]="budgetPercentUsed" aria-valuemin="0" aria-valuemax="100">
              {{formatNumber(budgetPercentUsed)}}%
            </div>
          </div>
          <div class="d-flex justify-content-between">
            <span><i class="fas fa-shopping-cart me-1"></i> Spent: <strong class="fs-5">E£{{formatNumber(expenseSummary.totalExpenses)}}</strong></span>
            <span><i class="fas fa-piggy-bank me-1"></i> Remaining: <strong class="fs-5" [ngClass]="{'text-danger': budgetRemaining < 0}">E£{{formatNumber(budgetRemaining)}}</strong></span>
          </div>
          
          <!-- Max Spend Limit when Goal is set -->
          <div *ngIf="goal.id" class="alert alert-info mt-3">
            <i class="fas fa-info-circle me-2"></i> To meet your savings goal of <strong>E£{{formatNumber(goal.target_amount)}}</strong>, 
            you should spend no more than <strong>E£{{formatNumber(maxSpendLimit)}}</strong> this month.
            <span *ngIf="expenseSummary.totalExpenses > maxSpendLimit" class="d-block mt-2 text-danger">
              <i class="fas fa-exclamation-triangle me-1"></i> You've already exceeded this limit by <strong>E£{{formatNumber(expenseSummary.totalExpenses - maxSpendLimit)}}</strong>
            </span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Goal Card -->
  <div class="card shadow mb-4" *ngIf="!isLoading">
    <div class="card-body p-4">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="text-primary mb-0">
          <i class="fas fa-bullseye me-2"></i> Savings Goal
        </h4>
        <div>
          <button [disabled]="!budget.id" class="btn btn-sm btn-outline-primary me-2" (click)="toggleGoalForm()">
            <i class="fas fa-{{ showGoalForm ? 'times' : 'edit' }} me-1"></i> {{ showGoalForm ? 'Cancel' : (goal.id ? 'Edit' : 'Set') }}
          </button>
          <button *ngIf="goal.id" class="btn btn-sm btn-outline-danger" (click)="deleteGoal(goal.id)">
            <i class="fas fa-trash-alt me-1"></i> Remove
          </button>
        </div>
      </div>
      
      <!-- Goal Form -->
      <div *ngIf="showGoalForm" class="mb-3 p-3 bg-light rounded">
        <form (ngSubmit)="onSubmitGoal(goalForm)" #goalForm="ngForm">
          <div class="mb-3">
            <label for="goalName" class="form-label fw-bold">Goal Name:</label>
            <input
              #goalNameInput
              type="text"
              id="goalName"
              [(ngModel)]="goal.name"
              name="goalName"
              class="form-control"
              placeholder="E.g., trip"
              required
              #goalName="ngModel"
              [ngClass]="{
                'is-invalid': goalName.invalid && (goalName.dirty || goalName.touched || goalSubmitted)
              }"
            />
            <div *ngIf="goalName.invalid && (goalName.dirty || goalName.touched || goalSubmitted)" class="text-danger">
              <div *ngIf="goalName.errors?.['required']"><i class="fas fa-exclamation-circle me-1"></i> Goal Name is required.</div>
            </div>
          </div>
          
          <div class="mb-3">
            <label for="targetAmount" class="form-label fw-bold">Target Amount:</label>
            <input
              type="number"
              id="targetAmount"
              [(ngModel)]="goal.target_amount"
              name="targetAmount"
              class="form-control"
              placeholder="Enter the target amount"
              required
              min="1"
              #targetAmount="ngModel"
              [ngClass]="{
                'is-invalid': targetAmount.invalid && (targetAmount.dirty || targetAmount.touched || goalSubmitted)
              }"
            />
            <div *ngIf="targetAmount.invalid && (targetAmount.dirty || targetAmount.touched || goalSubmitted)" class="text-danger">
              <div *ngIf="targetAmount.errors?.['required']"><i class="fas fa-exclamation-circle me-1"></i> Target Amount is required.</div>
              <div *ngIf="targetAmount.errors?.['min']"><i class="fas fa-exclamation-circle me-1"></i> Target Amount must be greater than 0.</div>
            </div>
          </div>
          
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-save me-1"></i> {{ goal.id ? 'Update Goal' : 'Set Goal' }}
          </button>
        </form>
      </div>
      
      <!-- Goal Display -->
      <div *ngIf="!showGoalForm">
        <div *ngIf="!goal.id" class="text-muted">
          <div *ngIf="!budget.id">Please set a budget first to enable savings goals</div>
          <div *ngIf="budget.id">No savings goal set yet</div>
        </div>
        <div *ngIf="goal.id">
          <div class="mt-3">
            <div class="d-flex align-items-center mb-1">
              <i class="fa-solid fa-sack-dollar text-dark me-2"></i>
              <span>Target: <strong class="fs-5">{{ goal.name }}</strong></span>
            </div>
            <div class="d-flex align-items-center">
              <i class="fas fa-wallet text-dark me-2"></i>
              <span>Target Amount: <strong class="fs-5">E£{{ formatNumber(goal.target_amount) }}</strong></span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Analytics Toggle Button -->
  <div class="d-flex justify-content-end mb-4" *ngIf="!isLoading">
    <button class="btn btn-outline-primary" (click)="toggleAnalytics()">
      <i class="fas fa-chart-line me-2"></i> {{ showAnalytics ? 'Hide Details' : 'Show Details' }}
    </button>
    <button class="btn btn-outline-success ms-3" (click)="generatePDFReport()">
      <i class="fas fa-file me-2"></i> Export Report
    </button>
  </div>

  <!-- Analytics Dashboard -->
  <div class="card shadow mb-5" *ngIf="!isLoading && showAnalytics">
    <div class="card-header bg-primary text-white">
      <h4 class="mb-0"><i class="fas fa-chart-bar me-2"></i> Financial Details</h4>
    </div>
    <div class="card-body p-4">
      <div class="row">
        <div class="col-md-6 mb-4">
          <div class="card h-100">
            <div class="card-body">
              <h5 class="card-title category-title text-primary mb-4">
                <i class="fa fa-chart-pie me-2"></i> Expense Overview
              </h5>
              <ul class="list-group list-group-flush">
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  <div>
                    <i class="fas fa-calculator me-2 text-primary"></i> Total Expenses
                  </div>
                  <span class="badge bg-primary rounded-pill fs-6 p-2">E£{{formatNumber(expenseSummary.totalExpenses)}}</span>
                </li>
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  <div>
                    <i class="fas fa-calendar-day me-2 text-info"></i> Daily Average
                  </div>
                  <span class="badge bg-info rounded-pill fs-6 p-2">E£{{formatNumber(expenseSummary.dailyAverage)}}</span>
                </li>
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  <div>
                    <i class="fas fa-arrow-up me-2 text-warning"></i> Highest Expense
                  </div>
                  <span class="badge bg-warning rounded-pill fs-6 p-2">E£{{formatNumber(expenseSummary.highestExpense)}}</span>
                </li>
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  <div>
                    <i class="fas fa-tag me-2 text-success"></i> Highest Category
                  </div>
                  <span class="badge bg-success rounded-pill fs-6 p-2">{{expenseSummary.highestCategory}}</span>
                </li>
              </ul>
            </div>
          </div>
        </div>
        <div class="col-md-6 mb-4">
          <div class="card h-100">
            <div class="card-body">
              <h5 class="card-title category-title text-primary mb-4">
                <i class="fas fa-tags me-2"></i> Category Breakdown
              </h5>
              <ul class="list-group list-group-flush">
                <li class="list-group-item d-flex justify-content-between align-items-center"
                    *ngFor="let category of categories">
                  <div>
                    <i class="fas fa-circle me-2" [style.color]="getCategoryColor(category)"></i>
                    {{category}}
                  </div>
                  <span class="badge rounded-pill fs-6 p-2" [style.background-color]="getCategoryColor(category)">
                    E£{{formatNumber(expenseSummary.categoryTotals[category] || 0)}}
                  </span>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Expense Form Card -->
  <div class="card shadow mb-5" *ngIf="!isLoading">
    <div class="card-header bg-primary text-white">
      <h4 class="mb-0"><i class="fa-solid fa-credit-card me-2"></i> {{ isEditing ? 'Update Expense' : 'Record New Expense' }}</h4>
    </div>
    <div class="card-body p-4 p-md-5">
      <!-- Expense Form -->
      <form (ngSubmit)="onSubmit(expenseForm)" #expenseForm="ngForm">
        <!-- Category -->
        <div class="mb-4">
          <label for="category" class="form-label fw-bold">
            <i class="fas fa-tags me-2 text-primary"></i> Category
          </label>
          <select
            #categoryInput
            id="category"
            [(ngModel)]="form.category"
            name="category"
            class="form-select form-select-lg"
            required
            #category="ngModel"
          >
            <option value="" disabled selected>Select an expense category</option>
            <option *ngFor="let category of categories" [value]="category">{{ category }}</option>
          </select>
          <div *ngIf="category.invalid && (category.dirty || category.touched || expenseSubmitted)" class="text-danger mt-1">
            <div *ngIf="category.errors?.['required']"><i class="fas fa-exclamation-circle me-1"></i> Please select a category.</div>
          </div>
        </div>

        <!-- Amount -->
        <div class="mb-4">
          <label for="amount" class="form-label fw-bold">
            <i class="fas fa-coins me-2 text-primary"></i> Amount
          </label>
          <input
            type="number"
            id="amount"
            [(ngModel)]="form.amount"
            name="amount"
            class="form-control form-control-lg"
            placeholder="E£ 0.00"
            required
            min="1"
            #amount="ngModel"
          />
          <div *ngIf="amount.invalid && (amount.dirty || amount.touched || expenseSubmitted)" class="text-danger mt-1">
            <div *ngIf="amount.errors?.['required']"><i class="fas fa-exclamation-circle me-1"></i> Please enter an amount.</div>
            <div *ngIf="amount.errors?.['min']"><i class="fas fa-exclamation-circle me-1"></i> Amount must be greater than 0.</div>
          </div>
        </div>

        <!-- Date -->
        <div class="mb-4">
          <label for="date" class="form-label fw-bold">
            <i class="fas fa-calendar-alt me-2 text-primary"></i> Date
          </label>
          <input
            type="date"
            id="date"
            [(ngModel)]="form.date"
            name="date"
            class="form-control form-control-lg"
            required
            [min]="minDate"
            [max]="maxDate"
            #date="ngModel"
          />
          <div *ngIf="date.invalid && (date.dirty || date.touched || expenseSubmitted)" class="text-danger mt-1">
            <div *ngIf="date.errors?.['required']"><i class="fas fa-exclamation-circle me-1"></i> Please select a date.</div>
          </div>
        </div>

        <!-- Description -->
        <div class="mb-4">
          <label for="description" class="form-label fw-bold">
            <i class="fas fa-align-left me-2 text-primary"></i> Description
          </label>
          <textarea
            id="description"
            [(ngModel)]="form.description"
            name="description"
            class="form-control form-control-lg"
            placeholder="What was this expense for? (optional)"
            maxlength="100"
            rows="3"
            #description="ngModel"
          ></textarea>
          <small class="text-muted d-block mt-1">
            {{ form.description?.length || 0 }}/100 characters
          </small>
          <div *ngIf="description.dirty || description.touched || expenseSubmitted" class="text-danger mt-1">
            <div *ngIf="form.description?.length === 100"><i class="fas fa-exclamation-circle me-1"></i> Description cannot exceed 100 characters.</div>
          </div>
        </div>

        <button type="submit" class="btn btn-primary btn-lg w-100 mt-4">
          <i class="fas fa-{{ isEditing ? 'save' : 'plus' }} me-2"></i> {{ isEditing ? 'Update Expense' : 'Add Expense' }}
        </button>
      </form>
    </div>
  </div>

  <!-- Expense List -->
  <div class="mt-5 mb-4 d-flex justify-content-between align-items-center" *ngIf="!isLoading">
    <h4 class="text-primary mb-0"><i class="fas fa-list-alt me-2"></i> Expense History</h4>
    <div class="d-flex">
      <span class="badge bg-primary p-2 me-2">{{ allExpenses.length }} Expenses</span>
      <span class="badge bg-success p-2">Total: E£{{ formatNumber(expenseSummary.totalExpenses) }}</span>
    </div>
  </div>
  
  <!-- Filtering Options - Always visible even with no expenses -->
  <div *ngIf="!isLoading" class="card shadow-sm mb-4">
    <div class="card-body p-3 p-md-4">
      <div class="row">
        <div class="col-md-6 mb-3 mb-md-0">
          <label for="categoryFilter" class="form-label fw-bold">
            <i class="fas fa-filter me-2 text-primary"></i> Filter by Category
          </label>
          <select 
            id="categoryFilter" 
            class="form-select"
            [(ngModel)]="selectedCategory"
            (change)="filterByCategory()"
          >
            <option value="all">All Categories</option>
            <option *ngFor="let category of categories" [value]="category">{{ category }}</option>
          </select>
        </div>
        <div class="col-md-6">
          <label for="sortBy" class="form-label fw-bold">
            <i class="fas fa-sort me-2 text-primary"></i> Sort Expenses
          </label>
          <select
            id="sortBy"
            class="form-select"
            [(ngModel)]="sortKey"
            (change)="sortExpenses()"
          >
            <option value="date">Date (Latest First)</option>
            <option value="amount">Amount (Highest First)</option>
          </select>
        </div>
      </div>
    </div>
  </div>

  <div *ngIf="!isLoading && expenses.length > 0" class="mt-3 mb-5">
    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3">
      <!-- Expense Card -->
      <div class="col" *ngFor="let expense of paginatedExpenses">
        <div class="card h-100 shadow-sm expense-card" [style.border-left]="'4px solid ' + getCategoryColor(expense.category)">
          <div class="card-body p-3">
            <div class="d-flex justify-content-between align-items-start mb-2">
              <h6 class="card-title mb-0 d-flex align-items-center">
                <i class="fas fa-circle me-2" [style.color]="getCategoryColor(expense.category)"></i>
                {{ expense.category }}
                <span *ngIf="expense.isRecentlyAdded" class="badge bg-success ms-2 small">NEW</span>
                <span *ngIf="isEditing && editingExpenseId === expense.id" class="badge bg-warning text-dark ms-2 small">EDITING</span>
              </h6>
              <span class="badge bg-secondary p-2">E£{{ formatNumber(expense.amount) }}</span>
            </div>
            
            <p class="card-text small text-muted mb-2">{{ expense.date | date:'MMM d, yyyy' }}</p>
            
            <p class="card-text small text-truncate mb-2" [title]="expense.description || 'No description'">
              {{ expense.description || 'No description' }}
            </p>
            
            <div class="d-flex justify-content-end gap-1 mt-2">
              <button
                class="btn btn-sm"
                [ngClass]="{
                  'btn-outline-primary': !(isEditing && editingExpenseId === expense.id),
                  'btn-warning text-dark': isEditing && editingExpenseId === expense.id
                }"
                (click)="editExpense(expense)"
                [disabled]="expense.isRecentlyAdded"
              >
                <i class="fas fa-pencil-alt"></i>
              </button>
              <button
                class="btn btn-outline-danger btn-sm"
                (click)="deleteExpense(expense.id)"
                [disabled]="expense.isRecentlyAdded"
              >
                <i class="fas fa-trash-alt"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- No Expenses Found -->
  <div *ngIf="!isLoading && expenses.length === 0" class="card shadow-sm mt-3 mb-5">
    <div class="card-body text-center py-5">
      <i class="fas fa-receipt text-muted mb-3 display-3"></i>
      <h5 class="text-muted mb-3">No expenses found for this month</h5>
      <p class="text-muted mb-4">Start tracking your expenses by adding your first transaction</p>
      <button class="btn btn-primary" (click)="focusCategoryInput()">
        <i class="fas fa-plus-circle me-2"></i> Add Your First Expense
      </button>
    </div>
  </div>

  <!-- Pagination Controls -->
  <nav *ngIf="!isLoading && totalPages > 1 && expenses.length > 0" aria-label="Expense page navigation">
    <ul class="pagination justify-content-center">
      <li class="page-item" [class.disabled]="currentPage === 1">
        <button class="page-link" (click)="changePage(currentPage - 1)" [disabled]="currentPage === 1">
          <i class="fas fa-chevron-left"></i>
        </button>
      </li>
      <li *ngFor="let page of pages" class="page-item" [class.active]="page === currentPage">
        <button class="page-link" (click)="changePage(page)">{{ page }}</button>
      </li>
      <li class="page-item" [class.disabled]="currentPage === totalPages">
        <button class="page-link" (click)="changePage(currentPage + 1)" [disabled]="currentPage === totalPages">
          <i class="fas fa-chevron-right"></i>
        </button>
      </li>
    </ul>
  </nav>
  
  <!-- Pagination Info -->
  <div *ngIf="!isLoading && totalPages > 1 && expenses.length > 0" class="text-center text-muted mb-4">
    <small>Showing {{ (currentPage - 1) * itemsPerPage + 1 }} to {{ (currentPage === totalPages) ? expenses.length : currentPage * itemsPerPage }} of {{ expenses.length }} expenses</small>
  </div>
</div>